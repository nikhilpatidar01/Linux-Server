
## SSL Bump with Squid Proxy üîí

### How HTTPS Works üîê
HTTPS uses Transport Layer Security (TLS) to securely encrypt communication between clients and servers.

- **Private Key** üîë: Secret, stored securely on the server.
- **Public Key** üåç: Shared publicly, encrypts data that only the private key can decrypt.

This encryption ensures privacy, integrity, and authentication of communications.


---

### 1. Create SSL Certificates for Squid üõ†Ô∏è

#### 1.1. Generate a Self-Signed CA (Certificate Authority) Certificate for Squid üîë

1. **Create the directory to store the SSL certificates**:
   ```bash
   mkdir -p /etc/squid/ssl_cert
   cd /etc/squid/ssl_cert
   openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 -keyout squidCA.key -out squidCA.crt
   cat squidCA.crt squidCA.key > squidCA.pem
   ```

#### 1.2. Verify that the certificate files are created ‚úÖ

1. **Check the directory**:
   ```bash
   ls -lh /etc/squid/ssl_cert
   ```
2. You should see `squidCA.key`, `squidCA.crt`, and `squidCA.pem`.

---

### 2. Prepare the SSL Database for Squid üóÉÔ∏è

#### 2.1. Create and initialize the SSL database Squid uses for dynamic certificate generation:
   ```bash
   mkdir -p /var/lib/squid
   /usr/lib64/squid/security_file_certgen -c -s /var/lib/squid/ssl_db -M 20MB
   chown -R squid:squid /var/lib/squid/ssl_db/
   ```

#### 2.2. Check the database:
   ```bash
   ls -lh /var/lib/squid/ssl_db/
   ```

---

### 3. Disable SELinux (Optional) ‚ö†Ô∏è

Disabling SELinux may avoid permission issues when running Squid in SSL bump mode.

#### 3.1. Edit the SELinux configuration file:
   ```bash
   vim /etc/sysconfig/selinux
   ```

#### 3.2. Set the following:
   ```bash
   SELINUX=disabled
   ```

#### 3.3. Check the SELinux status:
   ```bash
   sestatus
   ```

   If disabled, changes have taken effect. ‚úÖ

---

### 4. Configure Squid for SSL Bump ‚öôÔ∏è

#### 4.1. Edit the Squid configuration file:
   ```bash
   vim /etc/squid/squid.conf
   ```

#### 4.2. Update it with the following configuration:

```bash
# Squid normally listens to port 3128
# http_port 3128
http_port 3128 ssl-bump cert=/etc/squid/ssl_cert/squidCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB

# SSL Bump Configuration
acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all

# SSL Proxy Settings
http_access allow all

sslcrtd_program /usr/lib64/squid/security_file_certgen -s /var/lib/squid/ssl_db -M 4MB
sslcrtd_children 5
dns_v4_first on
```

---

### 5. Main Configuration File Example üìÑ

```bash
#
# Recommended minimum configuration:
#

# Example rule allowing access from your local networks.
# Adapt to list your (internal) IP networks from where browsing
# should be allowed
acl localnet src 0.0.0.0/8           # RFC 1122 "this" network (LAN)
acl localnet src 10.0.0.0/8          # RFC 1918 local private network (LAN)
acl localnet src 100.64.0.0/10       # RFC 6598 shared address space (CGN)
acl localnet src 169.254.0.0/16      # RFC 3927 link-local (directly plugged) machines
acl localnet src 172.16.0.0/12       # RFC 1918 local private network (LAN)
acl localnet src 192.168.0.0/16      # RFC 1918 local private network (LAN)
acl localnet src fc00::/7            # RFC 4193 local private network range
acl localnet src fe80::/10           # RFC 4291 link-local (directly plugged) machines

acl SSL_ports port 443
acl Safe_ports port 80            # http
acl Safe_ports port 21            # ftp
acl Safe_ports port 443           # https
acl Safe_ports port 70            # gopher
acl Safe_ports port 210           # wais
acl Safe_ports port 1025-65535    # unregistered ports
acl Safe_ports port 280           # http-mgmt
acl Safe_ports port 488           # gss-http
acl Safe_ports port 591           # filemaker
acl Safe_ports port 777           # multiling http

#
# Recommended minimum Access Permission configuration:
#
# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost
http_access allow localhost manager
http_access deny manager

# We strongly recommend the following be uncommented to protect innocent
# web applications running on the proxy server who think the only
# one who can access services on "localhost" is a local user
# http_access deny to_localhost

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#

# Example rule allowing access from your local networks.
# Adapt localnet in the ACL section to list your (internal) IP networks
# from where browsing should be allowed
http_access allow localnet
http_access allow localhost

# And finally deny all other access to this proxy
http_access deny all

# Squid normally listens to port 3128
# http_port 3128
http_port 3128 ssl-bump cert=/etc/squid/ssl_cert/squidCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB

# SSL Bump Configuration
acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all

# SSL Proxy Settings
http_access allow all

sslcrtd_program /usr/lib64/squid/security_file_certgen -s /var/lib/squid/ssl_db -M 4MB
sslcrtd_children 5
dns_v4_first on

# Uncomment and adjust the following to add a disk cache directory.
# cache_dir ufs /var/spool/squid 100 16 256

# Leave coredumps in the first cache dir
coredump_dir /var/spool/squid

#
# Add any of your own refresh_pattern entries above these.
#
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
```

---

### 6. Restart Squid üîÑ

#### 6.1. Apply the configuration changes:
   ```bash
   systemctl restart squid.service
   ```

#### 6.2. Verify Squid is running and listening:
   ```bash
   netstat -nltup | grep squid
   ```
   You should see Squid listening on port 3128. ‚úÖ

---

### 7. Enable IP Forwarding üåê

#### 7.1. Edit the sysctl configuration:
   ```bash
   sudo vim /etc/sysctl.d/ipv4_forward.conf
   ```

#### 7.2. Add the following line:
   ```bash
   net.ipv4.ip_forward = 1
   ```

#### 7.3. Apply the changes:
   ```bash
   sysctl --system
   ```

#### 7.4. Verify IP forwarding is enabled:
   ```bash
   sysctl net.ipv4.ip_forward
   ```

   **Expected Output**:
   ```
   net.ipv4.ip_forward = 1
   ```

---

### 8. Configure Firewalld for Squid Proxy and IP Forwarding üî•

#### 8.1. Open necessary ports (Squid proxy and HTTP):
   ```bash
   sudo firewall-cmd --permanent --zone=public --add-port=3128/tcp
   sudo firewall-cmd --permanent --zone=public --add-port=80/tcp
   ```

#### 8.2. Enable masquerading (required for IP forwarding/NAT):
   ```bash
   firewall-cmd --permanent --add-masquerade
   ```

#### 8.3. Reload firewall rules:
   ```bash
   sudo firewall-cmd --reload
   ```

#### 8.4. Verify changes:
   ```bash
   sudo firewall-cmd --list-all
   ```

   **Output Example**:
   ```
   public (active)
     interfaces: eth0
     services: ssh
     ports: 3128/tcp 80/tcp
     masquerade: yes
     ...
   ```

---

### 9. Distribute the Squid CA Certificate to Clients üì°

#### 9.1. Serve the Squid CA certificate over HTTP:
   Copy the certificate to the web server directory (Apache must be installed and running):
   ```bash
   cp -v /etc/squid/ssl_cert/squidCA.crt /var/www/html/
   ```

#### 9.2. Clients can download it by accessing:
   ```
   http://<proxy-server-ip>/squidCA.crt
   ```

   **Example** (if your proxy server IP is `192.168.2.1`):
   ```
   http://192.168.1.1/squidCA.crt
   ```

   > ‚ö†Ô∏è Note: Ensure the port is correct (`80` by default unless otherwise configured).

---

### 10. ‚úÖ For Firefox üî•

#### 10.1. Open Firefox ‚Üí Go to**:  
   **Settings ‚Üí Privacy & Security ‚Üí Certificates ‚Üí View Certificates**

#### 10.2. Click Import, select `squidCA.crt`.

#### 10.3. Tick both checkboxes:
   - Trust this CA to identify websites. ‚úÖ
   - Trust this CA to identify email users (optional). ‚úÖ

#### 10.4. Click OK.

---

### 11. ‚úÖ Configure Proxy on Client PC Browser üåç

1. **Open your browser** (Chrome, Firefox, etc.).
2. **Go to Settings** ‚Üí Search for **‚Äúproxy‚Äù**.
3. **Click on** "Open your computer‚Äôs proxy settings".
4. **In the Manual Proxy Setup** section:
   - Turn **"Use a proxy server"** to **ON**. ‚úÖ
   - Enter:
     - **IP Address**: `192.168.1.1` (replace with your actual proxy server IP)
     - **Port**: `3128`
5. **Save the settings**. üíæ

---

### 12. ‚úÖ Now, all HTTP/HTTPS traffic from the browser will be routed through Squid Proxy on port 3128.

> ‚úÖ Make sure the client system is in the same network as the proxy server.

---

### 13. ‚ùå Error Message (Sample Squid Error) ‚ö†Ô∏è

```
The requested URL could not be retrieved
URL: //‚Äî.googl.com/
Connection to 2003 failed. System returned: (101) Network is unreachable
```

**Explanation**: Squid tried to connect to an **IPv6 address** which is **not reachable** or misconfigured.

---

### 14. ‚úÖ Solutions:

1. **Force Squid to Prefer IPv4**:
   ```bash
   sudo vim /etc/squid/squid.conf
   ```
   Add at the **top** of the file:
   ```bash
   dns_v4_first on
   ```

   Restart Squid:
   ```bash
   sudo systemctl restart squid
   ```

2. **Disable IPv6 System-Wide** (if not using IPv6):
   ```bash
   sudo vim /etc/sysctl.conf
   ```
   Add:
   ```bash
   net.ipv6.conf.all.disable_ipv6 = 1
   net.ipv6.conf.default.disable_ipv6 = 1
   ```

   Apply changes:
   ```bash
   sudo sysctl -p
   ```

3. **Correct the URL Typo**:
   Wrong URL:
   ```
   https://waq.googt.com/
   ```
   Correct URL:
   ```
   https://www.google.com/
   ```

---

### 15. Quick Summary üìù

| Problem               | Solution                            |
|-----------------------|-------------------------------------|
| IPv6 Not Available     | Add `dns_v4_first on` in squid.conf |
| No IPv6 Needed         | Disable via `sysctl.conf`           |
| Typo in URL            | Correct the URL                     |

---
